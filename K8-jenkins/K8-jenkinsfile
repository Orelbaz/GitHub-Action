pipeline {
    agent any
    environment {
        MY_PATH = '/var/lib/jenkins/workspace/K8-pipeline/Jenkins/'    
        TEST_IP = sh(script: "aws ec2 describe-instances --region eu-central-1 --filters Name=tag:tagas,Values=test --query 'Reservations[].Instances[].PublicIpAddress' --output text", returnStdout: true).trim()
        PROD_IP = sh(script: "aws ec2 describe-instances --region eu-central-1 --filters Name=tag:tagas,Values=prod --query 'Reservations[].Instances[].PublicIpAddress' --output text", returnStdout: true).trim()
    }
    stages {
        stage('Cleanup') {
            steps {
                //cleanup
                sh 'rm -rf *'
                sh 'docker rmi $(docker images -q orelbaz/coinsiteK8)'
            }
        }
        stage('Build') {
            steps {
                sh 'echo "Cloning repository..."'
                sh 'git clone https://github.com/Orelbaz/Jenkins.git'
                sh 'ls'
                sh 'echo "Dockring..."'
                dir(MY_PATH + 'K8-jenkins/CoinSite') {
                    script {
                        // Extract the TAG variable from .env file
                        TAG = sh(script: "cat .env | grep TAG | cut -d '=' -f2", returnStdout: true).trim()
                        // Build and push the Docker image....
                        sh "docker build --build-arg TAG=${TAG} -t orelbaz/coinsiteK8:${TAG} ."
                        sh "docker push orelbaz/coinsiteK8:${TAG}"
                    }
                }
            }
        }
        stage('Test-server') {
            steps {
                sh "/bin/bash -x ${MY_PATH}K8-jenkins/deploy.sh ${TEST_IP} ${TAG}"
                sh 'echo "Running tests..."'
                sh "/bin/bash -x ${MY_PATH}K8-jenkins/Testing.sh"
            }
        }
        stage('Aprove') {
            steps {
                sh 'echo "Waiting for approval.."'
                // For auto approval, add '//' before the input line. For manual approval, remove '//' from the input line.
                input 'Do you want to deploy the project to production?'
            }
        }
        stage('Prod-server') {
            steps {
                sh "/bin/bash ${MY_PATH}K8-jenkins/deploy.sh ${PROD_IP} ${TAG}"
            }
        }
    }
}
